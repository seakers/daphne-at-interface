<template>
    <div id="anomaly_diagnosis">
        <div class="is-title">
            Anomaly Diagnosis
            <span class="tutorialLink">
                <u v-on:click.prevent="diagnosisTutorial">?</u>
            </span>
        </div>
        <div class="is-content">
            <div class="is-content">
                <div v-if="(this.selectedSymptomsList.length === 0)" >
                    No anomalous symptoms selected.
                </div>
                <div v-else class="columns" style="margin: 0px; padding: 0px">
                    <div class="column is-10" style="margin: 0px; padding: 0px">
                        <ul>
                            <li v-on:click="deselectSymptom(symptom)" v-for="symptom in selectedSymptomsList" style="cursor: pointer">
                                {{symptom['detection_text']}}
                            </li>
                        </ul>
                    </div>
                    <div class="column is-2" style="margin: 0px; padding: 0px">
                      <button class="button" style="width: 52%; border-color: #0AFEFF; color: #0AFEFF; background: #002E2E"
                              id="request_diagnosis" v-on:click.prevent="requestDiagnosis">Diagnose
                      </button>
                      <button class="button" style="width: 38%; border-color: #0AFEFF; color: #0AFEFF; background: #002E2E"
                              id="clear_symptoms" v-on:click.prevent="clearSymptoms">Clear
                      </button>
                    </div>
                </div>
            </div>
            <div class="horizontal-divider" style="margin-top: 10px; margin-bottom: 10px"></div>
            <div class="is-content">
                <div v-if="diagnosisReport.length === 0">
                    <img v-if="isLoading"
                         src="assets/img/loader.svg"
                         style="display: block; margin: auto;"
                         height="40" width="40"
                         alt="Loading spinner">
                    <p v-else>No diagnosis reports requested.</p>
                </div>
                <div v-else class="columns" style="margin: 0px; padding: 0px">
                    <div class="column is-6" style="margin: 0px; padding: 0px">
                        <span style="margin-bottom:20px; color: #0AFEFF; background: #002E2E">The set of symptoms:</span>
                        <ul>
                            <li  v-for="symptom in diagnosisReport['symptoms_list']" v-on:click="recoverSymptomsList()" style="cursor: pointer">
                                {{symptom['detection_text']}}
                            </li>
                        </ul>
                    </div>
                    <div class="column is-6" style="margin: 0px; padding: 0px">
                        <span style="margin-bottom:20px; color: #0AFEFF; background: #002E2E">Could be caused by anomalies:</span>
                        <ul>
                            <li  v-on:click="selectAnomaly(anomaly['name'])" v-for="anomaly in diagnosisReport['diagnosis_list']" style="cursor: pointer">
                                {{anomaly['name']}} ({{anomaly['text_score']}})
                            </li>
                        </ul>
                    </div>
                    <div style="margin: 0px; padding: 0px">
                        <a script="float:right" v-on:click.prevent="clearFullDiagnosisReport">
                            x
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</template>

<script>
    import {mapGetters} from 'vuex';

    let loaderImage = require('../images/loader.svg');

    export default {
        name: "AnomalyDiagnosisWindow",

        data: function() {
            return {
                isLoading: false,
            }
        },

        computed: {
            ...mapGetters({
                selectedSymptomsList: 'getSelectedSymptomsList',
                lastSelectedSymptomsList: 'getLastSelectedSymptomsList',
                diagnosisReport: 'getDiagnosisReport',
                selectedAnomalies: 'getSelectedAnomaliesList',
            }),
        },

        methods: {
            deselectSymptom(symptom) {
                this.$store.dispatch('removeSelectedSymptom', symptom);
            },
            clearSymptoms() {
                this.$store.dispatch('clearSelectedSymptoms');
            },
            clearFullDiagnosisReport() {
                this.$store.dispatch('clearDiagnosisReport');
            },
            async requestDiagnosis() {
                this.isLoading = true;
                await this.$store.dispatch('requestDiagnosis', this.selectedSymptomsList);
                this.isLoading = false;
            },
            selectAnomaly(anomalyName) {
                if (!this.selectedAnomalies.includes(anomalyName)) {
                    this.$store.dispatch('addSelectedAnomaly', anomalyName);
                }
            },
            recoverSymptomsList() {
                this.$store.dispatch('recoverSymptomsList')
            },
            diagnosisTutorial(event) {
                this.$root.$emit('diagnosisTutorialIndividual');
            }
        }
    }
</script>

<style scoped>
li:hover{
  font-weight: bold;
}
</style>